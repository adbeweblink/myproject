<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>PANTONE Street Snap | Pro Edition</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Inter"', 'sans-serif'],
                        mono: ['"JetBrains Mono"', 'monospace'],
                    },
                    colors: {
                        'pantone-black': '#111111',
                        'studio-bg': '#F4F4F5',
                        'studio-card': '#FFFFFF',
                        'studio-border': '#E4E4E7',
                    },
                    boxShadow: {
                        'card': '0 4px 20px -2px rgba(0,0,0,0.05)',
                        'floating': '0 24px 48px -12px rgba(0,0,0,0.1)',
                        'inner-border': 'inset 0 0 0 1px rgba(0,0,0,0.06)',
                    },
                    animation: {
                        'slide-up': 'slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1)',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'fade-in': 'fadeIn 0.3s ease-out forwards',
                    },
                    keyframes: {
                        slideUp: {
                            '0%': { transform: 'translateY(10px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        * { 
            -webkit-tap-highlight-color: transparent;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .transition-smooth { transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1); }

        .monitor-bar { width: 100%; height: 100%; display: flex; }
        .monitor-color { flex: 1; height: 100%; position: relative; transition: flex 0.3s ease; }
        .monitor-bar:hover .monitor-color:hover { flex: 2.5; }

        .segmented-control { background: #F4F4F5; padding: 4px; border-radius: 10px; display: flex; gap: 2px; }
        .segment-btn {
            flex: 1; padding: 8px 0; text-align: center; font-size: 11px; font-weight: 600;
            border-radius: 8px; color: #71717A; cursor: pointer; letter-spacing: 0.05em;
            transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; gap: 6px;
        }
        .segment-btn:hover { color: #18181B; }
        .segment-btn.active { background: white; color: black; box-shadow: 0 1px 2px rgba(0,0,0,0.06); }

        .loading-container {
            position: absolute; inset: 0; background: rgba(255,255,255,0.85);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            z-index: 50; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
        }
        .loading-bar-bg { width: 140px; height: 3px; background: #E4E4E7; border-radius: 99px; overflow: hidden; position: relative; }
        .loading-bar-fill {
            position: absolute; top: 0; left: 0; bottom: 0; width: 40%;
            background: black; border-radius: 99px; animation: shimmer 1.5s infinite ease-in-out;
        }
        @keyframes shimmer { 0% { transform: translateX(-120%); } 100% { transform: translateX(300%); } }

        /* Toast Notification */
        #toast-container {
            position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
            z-index: 100; pointer-events: none; display: flex; flex-direction: column; gap: 8px;
            width: 90%; max-width: 400px;
        }
        .toast {
            background: rgba(17, 17, 17, 0.95); backdrop-filter: blur(8px);
            color: white; padding: 12px 20px; border-radius: 12px;
            font-size: 13px; font-weight: 500; display: flex; items-center; justify-content: space-between;
            box-shadow: 0 10px 30px -10px rgba(0,0,0,0.3);
            pointer-events: auto; animation: toastIn 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .toast.error { background: rgba(220, 38, 38, 0.95); }
        @keyframes toastIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes toastOut { from { transform: translateY(0); opacity: 1; } to { transform: translateY(10px); opacity: 0; } }
        
        /* Developing Effect Logic */
        #main-image {
            transition: filter 2.5s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.5s ease;
        }
        .film-developing {
            filter: blur(20px) grayscale(100%) brightness(1.1) contrast(0.8);
        }
        .film-developed {
            filter: blur(0px) grayscale(0%) brightness(1) contrast(1);
        }

        /* History Film Strip - Floating Style on Workspace */
        .history-thumb {
            transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
            border: 2px solid white;
            opacity: 0.7;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            background: white;
        }
        .history-thumb:hover { opacity: 1; transform: scale(1.1); z-index: 10; }
        .history-thumb.active {
            border-color: #111;
            opacity: 1;
            transform: scale(1.1);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
            z-index: 10;
        }

        /* Lightbox */
        .lightbox {
            position: fixed; inset: 0; z-index: 100;
            background: rgba(0,0,0,0.95);
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
        }
        .lightbox.open { opacity: 1; pointer-events: auto; }
        .lightbox img { max-width: 95vw; max-height: 95vh; box-shadow: 0 0 50px rgba(0,0,0,0.5); transform: scale(0.95); transition: transform 0.3s ease; }
        .lightbox.open img { transform: scale(1); }

        .lightbox-nav {
            position: absolute; top: 50%; transform: translateY(-50%);
            width: 48px; height: 48px; border-radius: 50%;
            background: rgba(255,255,255,0.1); color: white;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s ease; z-index: 60;
        }
        .lightbox-nav:hover { background: rgba(255,255,255,0.2); transform: translateY(-50%) scale(1.1); }
        .lightbox-nav:active { transform: translateY(-50%) scale(0.95); }
        .lightbox-nav.left { left: 24px; }
        .lightbox-nav.right { right: 24px; }
    </style>
</head>
<body class="bg-studio-bg text-pantone-black h-[100dvh] w-screen overflow-hidden flex flex-col selection:bg-black selection:text-white">

    <!-- Nav -->
    <nav class="h-14 bg-white/80 backdrop-blur-md border-b border-studio-border flex items-center justify-between px-4 md:px-6 shrink-0 z-40 transition-smooth">
        <div class="flex items-center gap-3">
            <div class="w-7 h-7 bg-black text-white flex items-center justify-center font-bold text-[11px] rounded-[4px] shadow-sm">P</div>
            <div class="flex flex-col">
                <h1 class="font-bold text-xs tracking-tight leading-none uppercase text-zinc-900">PANTONE Street Snap</h1>
                <span class="text-[9px] text-zinc-400 tracking-[0.2em] uppercase mt-0.5">Pro v3.4</span>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <button id="btn-download" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-zinc-100 text-zinc-500 hover:text-black transition-colors" aria-label="Download Image" title="Download">
                <i data-lucide="download" class="w-4 h-4"></i>
            </button>
            <div class="relative group">
                <select id="lang-select" class="appearance-none bg-transparent text-[10px] font-bold text-zinc-500 hover:text-black focus:outline-none cursor-pointer uppercase tracking-widest pr-4 py-1 text-right transition-colors">
                    <option value="zh-TW">繁體中文</option>
                    <option value="en-US">English</option>
                    <option value="ja-JP">日本語</option>
                </select>
                <div class="absolute right-0 top-1/2 -translate-y-1/2 pointer-events-none">
                    <i data-lucide="chevron-down" class="w-3 h-3 text-zinc-400"></i>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Layout -->
    <main class="flex-1 flex flex-col-reverse md:flex-row overflow-hidden relative">
        
        <!-- Sidebar Controls -->
        <aside class="w-full md:w-[380px] bg-white border-t md:border-t-0 md:border-r border-studio-border flex flex-col h-[55dvh] md:h-full z-20 shadow-[0_-4px_24px_rgba(0,0,0,0.05)] md:shadow-[4px_0_24px_-12px_rgba(0,0,0,0.05)] shrink-0" id="sidebar">
            
            <div class="flex-1 overflow-y-auto no-scrollbar flex flex-col min-h-0">
                
                <!-- Palette Section -->
                <div class="p-4 md:p-6 border-b border-studio-border shrink-0">
                    <div class="flex items-center justify-between mb-3 md:mb-4">
                        <h2 class="text-[10px] font-bold text-zinc-400 uppercase tracking-[0.2em] flex items-center gap-2">
                            <i data-lucide="grid-2x2" class="w-3 h-3"></i>
                            <span data-i18n="label_2026_palettes">2026 PALETTE</span>
                        </h2>
                        <div class="flex gap-2">
                            <button id="palette-prev" class="w-7 h-7 rounded-full border border-zinc-200 flex items-center justify-center hover:bg-black hover:border-black hover:text-white transition-all active:scale-95"><i data-lucide="chevron-left" class="w-3.5 h-3.5"></i></button>
                            <button id="palette-next" class="w-7 h-7 rounded-full border border-zinc-200 flex items-center justify-center hover:bg-black hover:border-black hover:text-white transition-all active:scale-95"><i data-lucide="chevron-right" class="w-3.5 h-3.5"></i></button>
                        </div>
                    </div>
                    
                    <div class="group cursor-pointer rounded-2xl p-1 transition-smooth ring-2 ring-transparent hover:ring-zinc-100 active:scale-[0.98] select-none touch-pan-y" id="palette-area">
                        <div class="h-20 md:h-28 w-full rounded-xl overflow-hidden shadow-inner-border bg-zinc-50 relative">
                             <div class="absolute inset-y-0 left-0 w-8 bg-gradient-to-r from-black/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none md:hidden flex items-center justify-center"><i data-lucide="chevron-left" class="w-4 h-4 text-white/50"></i></div>
                             <div class="absolute inset-y-0 right-0 w-8 bg-gradient-to-l from-black/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none md:hidden flex items-center justify-center"><i data-lucide="chevron-right" class="w-4 h-4 text-white/50"></i></div>
                             <div class="monitor-bar" id="palette-visual"></div>
                        </div>
                        <div class="mt-2 md:mt-4 px-1 flex items-end justify-between">
                            <div>
                                <h3 class="text-xs md:text-sm font-bold text-zinc-900 leading-tight tracking-tight" id="palette-name">...</h3>
                            </div>
                            <span class="text-[9px] md:text-[10px] font-mono text-zinc-300 font-bold" id="palette-counter">01/07</span>
                        </div>
                        <p class="text-[9px] md:text-[10px] text-zinc-400 font-medium mt-1 tracking-wide px-1 hidden md:block" id="palette-desc">...</p>
                    </div>
                </div>

                <!-- Single Color Section -->
                <div class="p-4 md:p-6 border-b border-studio-border flex-1 flex flex-col min-h-0 relative">
                    <div class="flex items-center justify-between mb-3 md:mb-4">
                        <h2 class="text-[10px] font-bold text-zinc-400 uppercase tracking-[0.2em] flex items-center gap-2">
                            <i data-lucide="droplet" class="w-3 h-3"></i>
                            <span data-i18n="label_select_year">CLASSIC COLOR</span>
                        </h2>
                        <span class="text-[9px] font-bold bg-zinc-900 text-white px-2 py-0.5 rounded-full font-mono shadow-sm" id="year-display">...</span>
                    </div>
                    
                    <div class="relative w-full flex-1 rounded-xl transition-all duration-300 group perspective-1000 p-1 select-none touch-pan-y" id="color-card-wrapper">
                         <div class="absolute top-1/2 -translate-y-1/2 -left-3 -right-3 flex justify-between z-30 pointer-events-none opacity-0 group-hover:opacity-100 transition-opacity duration-300 px-1">
                            <button id="color-prev" class="pointer-events-auto w-8 h-8 rounded-full bg-white shadow-lg border border-zinc-100 flex items-center justify-center hover:scale-110 transition-transform active:scale-95 text-zinc-700"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                            <button id="color-next" class="pointer-events-auto w-8 h-8 rounded-full bg-white shadow-lg border border-zinc-100 flex items-center justify-center hover:scale-110 transition-transform active:scale-95 text-zinc-700"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                         </div>

                         <div id="classic-card-container" class="w-full h-full cursor-pointer flex flex-col rounded-xl overflow-hidden shadow-sm border border-zinc-200 transition-smooth hover:shadow-md bg-white">
                             <!-- Injected by JS -->
                         </div>
                    </div>
                </div>
            
            </div>

            <!-- Action Area -->
            <div class="p-4 md:p-6 bg-white shrink-0 space-y-3 md:space-y-4 shadow-[0_-4px_20px_-2px_rgba(0,0,0,0.03)] z-30 pb-safe border-t border-studio-border md:border-t-0">
                <div class="grid grid-cols-2 gap-2 md:gap-3">
                    <button id="btn-apply" class="col-span-2 py-3 bg-zinc-900 text-white rounded-xl text-[10px] font-bold tracking-[0.15em] uppercase hover:bg-black hover:shadow-lg hover:-translate-y-0.5 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:translate-y-0 disabled:hover:shadow-none transition-all flex items-center justify-center gap-2 group">
                        <i data-lucide="wand-2" class="w-3.5 h-3.5 group-hover:rotate-12 transition-transform"></i>
                        <span data-i18n="btn_apply_color">APPLY COLOR</span>
                    </button>
                    
                    <div class="relative group/upload">
                         <input type="file" id="file-upload" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                         <button class="w-full py-2.5 bg-white border border-zinc-200 text-zinc-900 rounded-xl text-[10px] font-bold uppercase group-hover/upload:border-zinc-900 transition-colors flex items-center justify-center gap-2 shadow-sm">
                            <i data-lucide="upload-cloud" class="w-3.5 h-3.5 text-zinc-400 group-hover/upload:text-zinc-900 transition-colors"></i>
                            <span data-i18n="btn_upload">UPLOAD</span>
                        </button>
                    </div>
                    
                    <button id="btn-gen" class="py-2.5 bg-white border border-zinc-200 text-zinc-900 rounded-xl text-[10px] font-bold uppercase hover:border-zinc-900 hover:bg-zinc-50 transition-all flex items-center justify-center gap-2 shadow-sm">
                        <i data-lucide="aperture" class="w-3.5 h-3.5"></i>
                        <span data-i18n="btn_generate_demo">GENERATE</span>
                    </button>
                </div>
                
                <div class="flex gap-2">
                    <div class="segmented-control flex-1">
                        <button class="segment-btn season-btn" data-season="spring"><i data-lucide="flower-2" class="w-3 h-3"></i><span>春</span></button>
                        <button class="segment-btn season-btn" data-season="summer"><i data-lucide="sun" class="w-3 h-3"></i><span>夏</span></button>
                        <button class="segment-btn season-btn active" data-season="autumn"><i data-lucide="leaf" class="w-3 h-3"></i><span>秋</span></button>
                        <button class="segment-btn season-btn" data-season="winter"><i data-lucide="snowflake" class="w-3 h-3"></i><span>冬</span></button>
                    </div>
                    <div class="segmented-control w-[35%]">
                        <button class="segment-btn ratio-btn active" data-ratio="9:16"><i data-lucide="smartphone" class="w-3 h-3"></i></button>
                        <button class="segment-btn ratio-btn" data-ratio="16:9"><i data-lucide="rectangle-horizontal" class="w-3 h-3"></i></button>
                        <button class="segment-btn ratio-btn" data-ratio="1:1"><i data-lucide="square" class="w-3 h-3"></i></button>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Canvas Area -->
        <section class="flex-1 bg-studio-bg relative flex flex-col items-center justify-center p-4 md:p-6 overflow-hidden h-[45dvh] md:h-auto" id="canvas-section">
            <div class="absolute inset-0 opacity-[0.03] pointer-events-none" style="background-image: radial-gradient(#000 1px, transparent 1px); background-size: 24px 24px;"></div>

            <!-- CHANGED: History Strip is now Static (Block), Full width container, no longer absolute -->
            <div class="w-full max-w-md md:max-w-2xl flex gap-3 overflow-x-auto no-scrollbar p-2 mb-4 z-10 opacity-0 transition-opacity duration-300 shrink-0 min-h-[60px] items-center justify-center md:justify-start" id="history-container">
                <!-- Items injected via JS -->
            </div>

            <!-- Canvas Frame -->
            <!-- CHANGED: Added flex-1 and min-height-0 to handle flex layout gracefully -->
            <div class="relative max-w-full max-h-full transition-all duration-500 shadow-floating bg-white rounded-none md:rounded-lg overflow-hidden group/frame flex-1" id="canvas-frame" style="aspect-ratio: 9/16; min-height: 0;">
                
                <!-- Maximize Button (Top-Right overlay inside frame) -->
                <button id="btn-maximize" class="absolute top-4 right-4 z-30 w-8 h-8 bg-black/20 hover:bg-black/60 backdrop-blur-md text-white rounded-full flex items-center justify-center transition-all opacity-0 group-hover/frame:opacity-100 transform hover:scale-110 active:scale-95" title="Full Screen View">
                    <i data-lucide="maximize-2" class="w-4 h-4"></i>
                </button>

                <!-- Inner Frame Content -->
                <div class="absolute inset-0 flex items-center justify-center overflow-hidden bg-zinc-50">
                    
                    <!-- Empty State -->
                    <div id="empty-state" class="text-center opacity-60 flex flex-col items-center animate-slide-up">
                        <div class="w-16 h-16 md:w-20 md:h-20 border border-dashed border-zinc-300 rounded-full flex items-center justify-center mb-3 md:mb-5 bg-zinc-50 text-zinc-300">
                            <i data-lucide="image-plus" class="w-6 h-6 md:w-8 md:h-8"></i>
                        </div>
                        <h3 class="text-xs font-bold uppercase tracking-widest text-zinc-900 mb-1">Creative Workspace</h3>
                        <p class="text-[9px] text-zinc-400 font-mono" data-i18n="msg_start_hint">Select a color & Generate</p>
                    </div>

                    <!-- Main Image -->
                    <img id="main-image" class="hidden w-full h-full object-cover z-10" alt="Generated Content">

                    <!-- Loader -->
                    <div id="loader" class="hidden loading-container">
                        <div class="flex flex-col items-center gap-4">
                            <div class="loading-bar-bg">
                                <div class="loading-bar-fill" id="loading-fill"></div>
                            </div>
                            <p class="text-[9px] font-mono tracking-widest uppercase text-zinc-500 font-bold animate-pulse" id="loader-text">Developing Film...</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Lightbox Overlay -->
        <div id="lightbox" class="lightbox">
            <div class="relative w-full h-full flex items-center justify-center p-4">
                <button id="btn-close-lightbox" class="absolute top-6 right-6 text-white/70 hover:text-white transition-colors z-50">
                    <i data-lucide="x" class="w-8 h-8"></i>
                </button>
                
                <!-- NEW: Navigation Buttons -->
                <div class="lightbox-nav left" id="lb-prev">
                    <i data-lucide="chevron-left" class="w-6 h-6"></i>
                </div>
                <div class="lightbox-nav right" id="lb-next">
                    <i data-lucide="chevron-right" class="w-6 h-6"></i>
                </div>

                <img id="lightbox-img" src="" class="max-w-full max-h-full object-contain rounded-sm shadow-2xl">
            </div>
        </div>

        <!-- Toast Container -->
        <div id="toast-container"></div>
    </main>

    <script>
        // --- I18N CONFIGURATION ---
        const I18N = {
            "btn_generate_demo": { "zh-TW": "AI 街拍生成", "en-US": "AI SNAP", "ja-JP": "AIスナップ" },
            "btn_upload": { "zh-TW": "上傳照片", "en-US": "UPLOAD", "ja-JP": "写真アップ" },
            "btn_apply_color": { "zh-TW": "套用色彩", "en-US": "APPLY COLOR", "ja-JP": "色適用" },
            "label_2026_palettes": { "zh-TW": "2026 年度配色", "en-US": "2026 COLLECTION", "ja-JP": "2026 コレクション" },
            "label_select_year": { "zh-TW": "經典代表色", "en-US": "CLASSIC YEAR", "ja-JP": "クラシックイヤー" },
            "msg_start_hint": { "zh-TW": "選擇色彩並開始創作", "en-US": "Select Color & Create", "ja-JP": "色を選んで作成開始" },
            
            "error_no_image": { "zh-TW": "請先生成或上傳圖片", "en-US": "No image to edit", "ja-JP": "編集する画像がありません" },
            "error_api_fail": { "zh-TW": "AI 處理失敗，請稍後再試", "en-US": "AI Processing Failed", "ja-JP": "処理に失敗しました" },
            "error_policy": { "zh-TW": "內容觸發安全過濾，請重試", "en-US": "Safety blocked", "ja-JP": "安全フィルター" },
            "msg_select_color": { "zh-TW": "請先點選左側顏色", "en-US": "Select a color first", "ja-JP": "色を選択してください" },
            "msg_gen_success": { "zh-TW": "街拍生成完成", "en-US": "Street Snap Generated", "ja-JP": "生成完了" },
            "msg_edit_success": { "zh-TW": "色彩套用成功", "en-US": "Color Applied", "ja-JP": "色適用完了" },
            
            "palette_pastel": { "zh-TW": "粉彩柔和", "en-US": "Pastel Harmony", "ja-JP": "パステル" },
            "palette_pause": { "zh-TW": "歇息片刻", "en-US": "Moment of Respite", "ja-JP": "レスパイト" },
            "palette_atmos": { "zh-TW": "大氣氛圍", "en-US": "Atmospheric", "ja-JP": "アトモス" },
            "palette_comfort": { "zh-TW": "舒適地帶", "en-US": "Comfort Zone", "ja-JP": "コンフォート" },
            "palette_tropical": { "zh-TW": "熱帶風情", "en-US": "Tropical Vibe", "ja-JP": "トロピカル" },
            "palette_light": { "zh-TW": "光影交織", "en-US": "Light & Shadow", "ja-JP": "光と影" },
            "palette_glamour": { "zh-TW": "魅惑流光", "en-US": "Allure", "ja-JP": "アリュール" },

            "color_cloud_dancer": { "zh-TW": "雲上舞白", "en-US": "Cloud Dancer", "ja-JP": "クラウド・ダンサー" },
            "color_peach_fuzz": { "zh-TW": "溫潤蜜桃色", "en-US": "Peach Fuzz", "ja-JP": "ピーチ・法茲" },
            "color_viva_magenta": { "zh-TW": "萬歲洋紅", "en-US": "Viva Magenta", "ja-JP": "ビバ・マゼンタ" },
            "color_very_peri": { "zh-TW": "長春花藍", "en-US": "Very Peri", "ja-JP": "ベリー・ペリ" },
            "color_ultimate_gray": { "zh-TW": "極致灰", "en-US": "Ultimate Gray", "ja-JP": "アルティメット・グレイ" },
            "color_illuminating": { "zh-TW": "亮麗黃", "en-US": "Illuminating", "ja-JP": "イルミネイティング" },
            "color_classic_blue": { "zh-TW": "經典藍", "en-US": "Classic Blue", "ja-JP": "クラシック・ブルー" },
            "color_living_coral": { "zh-TW": "活珊瑚橘", "en-US": "Living Coral", "ja-JP": "リビング・コーラル" },
            "color_ultra_violet": { "zh-TW": "紫外光", "en-US": "Ultra Violet", "ja-JP": "ウルトラ・バイオレット" },
            "color_greenery": { "zh-TW": "草木綠", "en-US": "Greenery", "ja-JP": "グリーナリー" },
            "color_rose_quartz": { "zh-TW": "玫瑰石英粉", "en-US": "Rose Quartz", "ja-JP": "ローズ・クォーツ" },
            "color_serenity": { "zh-TW": "寧靜粉藍", "en-US": "Serenity", "ja-JP": "セレニティ" },

            "desc_cloud_dancer": { "zh-TW": "空靈白色，優雅且具包容性。", "en-US": "Ethereal and inclusive white.", "ja-JP": "優雅で包容力のある白色。" },
            "desc_peach_fuzz": { "zh-TW": "溫潤蜜桃色，撫慰人心。", "en-US": "Velvety gentle peach tone.", "ja-JP": "心を豊かにするピーチ。" },
            "desc_viva_magenta": { "zh-TW": "大膽洋紅，展現無畏勇氣。", "en-US": "Brave and fearless magenta.", "ja-JP": "大胆不敵なマゼンタ。" },
            "desc_very_peri": { "zh-TW": "長春花藍，激發無限創意。", "en-US": "Dynamic blue hue.", "ja-JP": "創造性を促す青。" },
            "desc_ultimate_gray": { "zh-TW": "堅實岩石灰，象徵韌性。", "en-US": "Solid and dependable gray.", "ja-JP": "強固で信頼できるグレー。" },
            "desc_illuminating": { "zh-TW": "溫暖明亮黃，帶來希望。", "en-US": "Cheerful sparkling yellow.", "ja-JP": "生き維和黃色。" },
            "desc_classic_blue": { "zh-TW": "永恆經典藍，簡約優雅。", "en-US": "Instilling calm and connection.", "ja-JP": "落ち着きをもたらす青。" },
            "desc_living_coral": { "zh-TW": "活力珊瑚橘，擁抱溫暖。", "en-US": "Animating and life-affirming.", "ja-JP": "活気のあるコーラル。" },
            "desc_ultra_violet": { "zh-TW": "神祕紫外光，獨創想像。", "en-US": "Thoughtful purple shade.", "ja-JP": "獨創的な紫。" },
            "desc_greenery": { "zh-TW": "清新草木綠，象徵新生。", "en-US": "Refreshing and revitalizing greenery.", "ja-JP": "爽やかな綠。" },
            "desc_rose_quartz": { "zh-TW": "溫柔石英粉，傳遞慈備。", "en-US": "Gentle and persuasive rose.", "ja-JP": "優しいローズ。" },
            "desc_serenity": { "zh-TW": "輕盈寧靜藍，帶來放鬆。", "en-US": "Weightless and airy blue.", "ja-JP": "空気のような青。" },
        };

        const COLORS = [
            { id: '11-4201', nameKey: 'color_cloud_dancer', descKey: 'desc_cloud_dancer', hex: '#F0EFEF', year: '2026' },
            { id: '13-1023', nameKey: 'color_peach_fuzz', descKey: 'desc_peach_fuzz', hex: '#FFBE98', year: '2025' },
            { id: '18-1750', nameKey: 'color_viva_magenta', descKey: 'desc_viva_magenta', hex: '#BB2649', year: '2023' },
            { id: '17-3938', nameKey: 'color_very_peri', descKey: 'desc_very_peri', hex: '#6667AB', year: '2022' },
            { id: '17-5104', nameKey: 'color_ultimate_gray', descKey: 'desc_ultimate_gray', hex: '#939597', year: '2021' },
            { id: '13-0647', nameKey: 'color_illuminating', descKey: 'desc_illuminating', hex: '#F5DF4D', year: '2021' },
            { id: '19-4052', nameKey: 'color_classic_blue', descKey: 'desc_classic_blue', hex: '#0F4C81', year: '2020' },
            { id: '16-1546', nameKey: 'color_living_coral', descKey: 'desc_living_coral', hex: '#FF6F61', year: '2019' },
            { id: '18-3838', nameKey: 'color_ultra_violet', descKey: 'desc_ultra_violet', hex: '#5F4B8B', year: '2018' },
            { id: '15-0343', nameKey: 'color_greenery', descKey: 'desc_greenery', hex: '#88B04B', year: '2017' },
            { id: '13-1520', nameKey: 'color_rose_quartz', descKey: 'desc_rose_quartz', hex: '#F7CAC9', year: '2016' },
            { id: '15-3919', nameKey: 'color_serenity', descKey: 'desc_serenity', hex: '#91A8D0', year: '2016' },
        ];

        const PALETTES = [
            { id: 'p1', nameKey: 'palette_pastel', colors: ['#F0EFEF', '#F8C8DC', '#B0E0E6', '#E6E6FA', '#FFF0F5', '#F5F5DC', '#F0FFF0', '#FAFAD2'], desc: "Soft, pleasing transitions." },
            { id: 'p2', nameKey: 'palette_pause', colors: ['#FABAC0', '#FCA289', '#C68E17', '#5D4037', '#FFDAB9', '#DEB887', '#CD853F', '#8B4513'], desc: "Pink Lemonade, Caramel, Cocoa." },
            { id: 'p3', nameKey: 'palette_atmos', colors: ['#F0EFEF', '#AAB1B7', '#88BADC', '#005F6A', '#E0FFFF', '#B0C4DE', '#4682B4', '#2F4F4F'], desc: "Cloud Dancer, Grey Sky, Teal." },
            { id: 'p4', nameKey: 'palette_comfort', colors: ['#F0EFEF', '#8FBC8F', '#D2B48C', '#556B2F', '#F5DEB3', '#D2691E', '#9ACD32', '#6B8E23'], desc: "Soothing greens and browns." },
            { id: 'p5', nameKey: 'palette_tropical', colors: ['#40E0D0', '#FFA500', '#FF1493', '#F0EFEF', '#00CED1', '#FF4500', '#FF69B4', '#7FFF00'], desc: "Turquoise, Citrus, Flowers." },
            { id: 'p6', nameKey: 'palette_light', colors: ['#FFFFFF', '#D3D3D3', '#778899', '#2F4F4F', '#F8F8FF', '#C0C0C0', '#696969', '#000000'], desc: "Soft tones and shadows." },
            { id: 'p7', nameKey: 'palette_glamour', colors: ['#FFFFFF', '#000000', '#C8102E', '#C0C0C0', '#FFFAFA', '#1A1A1A', '#DC143C', '#A9A9A9'], desc: "Lipstick Red, Silver, Black." }
        ];

        // State Machine
        // ADDED: history array
        const state = { lang: 'zh-TW', mode: null, pIndex: 0, cIndex: 0, ratio: '9:16', season: 'autumn', image: null, loading: false, history: [] };

        // DOM Elements
        const DOM = {
            lang: document.getElementById('lang-select'),
            pName: document.getElementById('palette-name'),
            pDesc: document.getElementById('palette-desc'),
            pCount: document.getElementById('palette-counter'),
            pVisual: document.getElementById('palette-visual'),
            pPrev: document.getElementById('palette-prev'),
            pNext: document.getElementById('palette-next'),
            pArea: document.getElementById('palette-area'),
            year: document.getElementById('year-display'),
            cContainer: document.getElementById('classic-card-container'),
            cPrev: document.getElementById('color-prev'),
            cNext: document.getElementById('color-next'),
            cWrapper: document.getElementById('color-card-wrapper'),
            ratioSegments: document.querySelectorAll('.ratio-btn'),
            seasonSegments: document.querySelectorAll('.season-btn'),
            btnGen: document.getElementById('btn-gen'),
            btnApply: document.getElementById('btn-apply'),
            btnDownload: document.getElementById('btn-download'),
            fileInput: document.getElementById('file-upload'),
            mainImg: document.getElementById('main-image'),
            emptyState: document.getElementById('empty-state'),
            loader: document.getElementById('loader'),
            loadingFill: document.getElementById('loading-fill'),
            loaderText: document.getElementById('loader-text'),
            canvasFrame: document.getElementById('canvas-frame'),
            toastContainer: document.getElementById('toast-container'),
            historyContainer: document.getElementById('history-container'), // Relocated
            btnMaximize: document.getElementById('btn-maximize'),
            lightbox: document.getElementById('lightbox'),
            lightboxImg: document.getElementById('lightbox-img'),
            btnCloseLightbox: document.getElementById('btn-close-lightbox'),
            lbPrev: document.getElementById('lb-prev'), // New
            lbNext: document.getElementById('lb-next') // New
        };

        // Utility: Show Toast
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span>${message}</span>`;
            if (type === 'error') toast.innerHTML += `<i data-lucide="alert-circle" class="w-4 h-4 ml-2"></i>`;
            else toast.innerHTML += `<i data-lucide="check" class="w-4 h-4 ml-2"></i>`;
            
            DOM.toastContainer.appendChild(toast);
            lucide.createIcons();

            setTimeout(() => {
                toast.style.animation = 'toastOut 0.3s forwards';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // --- HISTORY LOGIC ---
        function addToHistory(imgSrc) {
            if (state.history.includes(imgSrc)) return;
            state.history.unshift(imgSrc);
            if (state.history.length > 8) state.history.pop();
            renderHistory();
        }

        function renderHistory() {
            if (state.history.length === 0) {
                DOM.historyContainer.classList.add('opacity-0'); 
                return;
            }
            DOM.historyContainer.classList.remove('opacity-0');
            
            DOM.historyContainer.innerHTML = state.history.map((src, index) => `
                <img src="${src}" class="history-thumb w-8 h-8 md:w-10 md:h-10 rounded-md object-cover cursor-pointer shrink-0 ${src === state.image ? 'active' : ''}" onclick="displayImg('${src}', true)">
            `).join('');
        }

        // --- CORE RENDERING ---
        function render() {
            // Text Update
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const k = el.dataset.i18n; if(I18N[k]) el.innerText = I18N[k][state.lang];
            });

            // Palette Render
            const p = PALETTES[state.pIndex];
            DOM.pName.innerText = I18N[p.nameKey][state.lang].toUpperCase();
            DOM.pDesc.innerText = p.desc;
            DOM.pCount.innerText = `0${state.pIndex + 1}/0${PALETTES.length}`;
            DOM.pVisual.innerHTML = p.colors.map(c => `<div class="monitor-color" style="background-color:${c}"></div>`).join('');
            
            // Color Render
            const c = COLORS[state.cIndex];
            DOM.year.innerText = c.year;
            DOM.cContainer.innerHTML = `
                <div class="flex flex-col h-full w-full">
                     <div class="h-20 md:h-28 w-full shrink-0 transition-colors duration-500 relative" style="background-color:${c.hex}">
                        <div class="absolute bottom-2 right-2 text-white/50 text-[9px] font-mono">PANTONE</div>
                     </div>
                     <div class="flex-1 p-3 md:p-4 flex flex-col justify-start bg-white relative overflow-hidden">
                         <div class="flex justify-between items-start shrink-0">
                            <span class="font-bold text-xl md:text-2xl leading-none tracking-tighter text-zinc-900">${c.id}</span>
                         </div>
                         <span class="text-[9px] md:text-[10px] font-bold uppercase tracking-widest text-zinc-500 mb-2 mt-2 shrink-0">${I18N[c.nameKey][state.lang]}</span>
                         <div class="w-8 h-0.5 bg-zinc-200 mb-2 shrink-0"></div>
                         <div class="flex-1 overflow-y-auto no-scrollbar min-h-0">
                             <p class="text-[9px] md:text-[10px] leading-relaxed text-zinc-400">${I18N[c.descKey][state.lang]}</p>
                         </div>
                     </div>
                </div>
            `;

            // Selection Visuals & Ratio
            if(state.mode === 'palette') {
                DOM.pArea.classList.add('ring-zinc-900', 'bg-zinc-50'); DOM.pArea.classList.remove('ring-transparent');
                DOM.cWrapper.style.opacity = '0.5'; DOM.cWrapper.style.transform = 'scale(0.98)';
                DOM.pArea.style.opacity = '1'; DOM.pArea.style.transform = 'scale(1)';
                DOM.loadingFill.style.backgroundColor = p.colors[0];
            } else if (state.mode === 'single') {
                DOM.pArea.classList.remove('ring-zinc-900', 'bg-zinc-50'); DOM.pArea.classList.add('ring-transparent');
                DOM.cWrapper.style.opacity = '1'; DOM.cWrapper.style.transform = 'scale(1)';
                DOM.pArea.style.opacity = '0.5'; DOM.pArea.style.transform = 'scale(0.98)';
                DOM.cContainer.classList.add('ring-2', 'ring-zinc-900');
                DOM.cContainer.classList.remove('border-zinc-200');
                DOM.loadingFill.style.backgroundColor = c.hex;
            } else {
                DOM.pArea.classList.remove('ring-zinc-900', 'bg-zinc-50');
                DOM.cContainer.classList.remove('ring-2', 'ring-zinc-900');
                DOM.cContainer.classList.add('border-zinc-200');
                DOM.pArea.style.opacity = '1'; DOM.pArea.style.transform = 'scale(1)';
                DOM.cWrapper.style.opacity = '1'; DOM.cWrapper.style.transform = 'scale(1)';
                DOM.loadingFill.style.backgroundColor = 'black';
            }

            if(state.ratio === '16:9') DOM.canvasFrame.style.aspectRatio = '16/9';
            else if(state.ratio === '1:1') DOM.canvasFrame.style.aspectRatio = '1/1';
            else DOM.canvasFrame.style.aspectRatio = '9/16';
        }

        function setMode(m) { state.mode = m; render(); }

        // --- GESTURE SUPPORT (Swipe) ---
        let touchstartX = 0;
        let touchendX = 0;

        function handleGesture(elementId, prevAction, nextAction) {
            const zone = document.getElementById(elementId);
            zone.addEventListener('touchstart', e => { touchstartX = e.changedTouches[0].screenX; }, {passive: true});
            zone.addEventListener('touchend', e => {
                touchendX = e.changedTouches[0].screenX;
                if (touchendX < touchstartX - 50) nextAction(); // Swipe Left (Next)
                if (touchendX > touchstartX + 50) prevAction(); // Swipe Right (Prev)
            }, {passive: true});
        }

        // Init Gestures
        handleGesture('palette-area', 
            () => { state.pIndex = (state.pIndex - 1 + PALETTES.length) % PALETTES.length; setMode('palette'); },
            () => { state.pIndex = (state.pIndex + 1) % PALETTES.length; setMode('palette'); }
        );
        handleGesture('color-card-wrapper', 
            () => { state.cIndex = (state.cIndex - 1 + COLORS.length) % COLORS.length; setMode('single'); },
            () => { state.cIndex = (state.cIndex + 1) % COLORS.length; setMode('single'); }
        );

        // --- EVENT LISTENERS ---
        DOM.lang.onchange = (e) => { state.lang = e.target.value; render(); };

        DOM.pPrev.onclick = (e) => { e.stopPropagation(); state.pIndex = (state.pIndex - 1 + PALETTES.length) % PALETTES.length; setMode('palette'); };
        DOM.pNext.onclick = (e) => { e.stopPropagation(); state.pIndex = (state.pIndex + 1) % PALETTES.length; setMode('palette'); };
        DOM.pArea.onclick = () => setMode('palette');
        
        DOM.cPrev.onclick = (e) => { e.stopPropagation(); state.cIndex = (state.cIndex - 1 + COLORS.length) % COLORS.length; setMode('single'); };
        DOM.cNext.onclick = (e) => { e.stopPropagation(); state.cIndex = (state.cIndex + 1) % COLORS.length; setMode('single'); };
        DOM.cContainer.onclick = () => setMode('single');
        
        DOM.ratioSegments.forEach(btn => { 
            btn.onclick = () => { 
                DOM.ratioSegments.forEach(b => b.classList.remove('active')); 
                btn.classList.add('active'); 
                state.ratio = btn.dataset.ratio; 
                render(); 
            }; 
        });

        DOM.seasonSegments.forEach(btn => {
            btn.onclick = () => {
                DOM.seasonSegments.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                state.season = btn.dataset.season;
            };
        });

        // Download Feature
        DOM.btnDownload.onclick = () => {
            if (!state.image) { showToast(I18N['error_no_image'][state.lang], 'error'); return; }
            const link = document.createElement('a');
            link.href = state.image;
            link.download = `pantone-snap-${Date.now()}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast("Image Downloaded");
        };

        // --- LIGHTBOX LOGIC ---
        let lightboxIndex = 0;

        function updateLightboxImage() {
            if(state.history.length === 0) return;
            DOM.lightboxImg.src = state.history[lightboxIndex];
        }

        DOM.btnMaximize.onclick = (e) => {
            e.stopPropagation();
            if (!state.image) { showToast(I18N['error_no_image'][state.lang], 'error'); return; }
            
            // Find current image index in history, default to 0
            const idx = state.history.indexOf(state.image);
            lightboxIndex = idx >= 0 ? idx : 0;
            
            updateLightboxImage();
            DOM.lightbox.classList.add('open');
        };
        
        DOM.btnCloseLightbox.onclick = () => {
            DOM.lightbox.classList.remove('open');
        };
        
        DOM.lightbox.onclick = (e) => {
            if(e.target === DOM.lightbox) DOM.lightbox.classList.remove('open');
        }

        // Lightbox Navigation
        DOM.lbPrev.onclick = (e) => {
            e.stopPropagation();
            if(state.history.length === 0) return;
            lightboxIndex = (lightboxIndex + 1) % state.history.length; // Next in array is older in history
            updateLightboxImage();
        };

        DOM.lbNext.onclick = (e) => {
            e.stopPropagation();
            if(state.history.length === 0) return;
            lightboxIndex = (lightboxIndex - 1 + state.history.length) % state.history.length; // Prev in array is newer
            updateLightboxImage();
        };

        // Keyboard Navigation for Lightbox
        document.addEventListener('keydown', (e) => {
            if (!DOM.lightbox.classList.contains('open')) return;
            if (e.key === 'ArrowLeft') DOM.lbNext.click(); // Left visual = newer = lbNext logic
            if (e.key === 'ArrowRight') DOM.lbPrev.click(); // Right visual = older
            if (e.key === 'Escape') DOM.btnCloseLightbox.click();
        });

        // --- DISPLAY LOGIC WITH DEVELOPING EFFECT ---
        function displayImg(src, isHistoryRecall = false) { 
            state.image = src; 
            DOM.mainImg.src = src; 
            DOM.mainImg.classList.remove('hidden'); 
            DOM.emptyState.classList.add('hidden'); 

            if (!isHistoryRecall) {
                DOM.mainImg.className = 'w-full h-full object-cover z-10 film-developing';
                addToHistory(src);
                requestAnimationFrame(() => {
                    setTimeout(() => {
                        DOM.mainImg.className = 'w-full h-full object-cover z-10 film-developed';
                    }, 100); 
                });
            } else {
                DOM.mainImg.className = 'w-full h-full object-cover z-10 film-developed';
                renderHistory(); // Update active state
            }
        }

        // --- API INTEGRATION ---
        const apiKey = ""; // System injected

        async function fetchWithRetry(url, options, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) return response;
                    if (response.status === 401 || response.status >= 500) throw new Error(`HTTP ${response.status}`);
                    return response;
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000));
                }
            }
        }

        async function apiCall(type) {
            if(state.loading) return;
            
            if (type === 'edit') {
                if(!state.image) { showToast(I18N['error_no_image'][state.lang], 'error'); return; }
                if(!state.mode) { showToast(I18N['msg_select_color'][state.lang], 'error'); return; }
            }

            state.loading = true; 
            DOM.loader.classList.remove('hidden');
            DOM.loaderText.innerText = type === 'gen' ? "SHOOTING..." : "RE-STYLING...";
            DOM.btnGen.disabled = true;
            DOM.btnApply.disabled = true;

            // --- REFINED PROMPT ENGINEERING ---
            let ratioP = "";
            if(state.ratio === '16:9') { ratioP = "cinematic wide shot 16:9"; }
            if(state.ratio === '1:1') { ratioP = "square format 1:1"; }
            if(state.ratio === '9:16') { ratioP = "full body vertical 9:16"; }

            // EXPANDED POSES: Mix of High-Fashion Magazine & Natural Candid (NO static "standing at attention")
            const vibrantPoses = [
                // --- Magazine Cover Style (Confident, Eye Contact, Styled) ---
                "Fashion Magazine Cover: Walking powerfully towards camera, direct eye contact, coat flapping in wind, confident stride (ViVi style)",
                "High-End Editorial: Leaning casually against a wall/railing, one leg crossed, looking straight at camera with attitude, relaxed but chic",
                "Street Chic: Sitting on street steps or railing, relaxed posture, looking at camera, hand resting on knee, engaging gaze",
                "Dynamic Posing: Body turned 45 degrees, looking back at camera over shoulder (Backwards Glance), intense gaze, hair in motion",
                "Close-up Vibe: Hands near face or adjusting sunglasses, looking at camera, slight tilt of head, charming expression",

                // --- Natural Candid Street Snaps (Unaware, Moving) ---
                "Walking naturally down the street, looking slightly to the side, hair blowing in wind (Natural Candid)",
                "Waiting at a crosswalk, fixing hair behind ear, holding a bag, looking down (Daily Moment)",
                "Crossing the street, mid-stride, looking intently at traffic, purposeful movement",
                "Standing by a shop window, side profile, looking away at the city view, relaxed posture",
                "Walking briskly, skirt swirling, looking at a distance, unaware of camera",
                "Laughing naturally, hand covering mouth, eyes closed in joy, candid street moment",
                "Hailing a taxi, arm raised, side profile, dynamic motion",
                "Walking past camera, sharp side profile, focused expression"
            ];
            const p = vibrantPoses[Math.floor(Math.random() * vibrantPoses.length)];
            
            // Random Lighting Factor to ensure variety + SHADOW LOGIC
            const lightingOpts = [
                "Soft overcast light with soft ground shadows (Fujifilm Pro 400H style)", 
                "Dynamic sunlight from left with distinct cast shadow (Kodak Portra 400 style)", 
                "Cinematic golden hour with long dramatic shadows and lens flare", 
                "High contrast shadow patterns from trees, dappled light on face", 
                "Backlit glowing hair with silhouette shadow on ground, dreamlike atmosphere", 
                "Crisp morning light with sharp foot shadows, high fidelity"
            ];
            const randomLight = lightingOpts[Math.floor(Math.random() * lightingOpts.length)];
            
            // Random Detail
            const details = ["holding a small clutch", "adjusting sunglasses", "holding a coffee cup", "walking fast", "wind blowing hair"];
            const randomDetail = details[Math.floor(Math.random() * details.length)];

            // --- NEW: FACE & HAIR VARIATION ENGINE ---
            // EXCLUDED: Short hair, curly bobs, phoenix eyes.
            // INCLUDED: Long flowing hair types, gentle eye shapes.
            const faceShapes = ["Oval face shape", "Heart-shaped face", "Soft diamond face shape", "Slender V-line face"];
            
            // Fixed: Removed feline/phoenix eyes. Focus on round/large eyes.
            const eyeTypes = ["Large round doe eyes", "Soft smiling eyes", "Clear bright eyes", "Almond-shaped eyes (non-slanted)"];
            
            // Fixed: REPLACED High Ponytail with Low Ponytail. ADDED Bangs to ALL styles.
            const hairStyles = [
                "Long straight hair with soft big waves at ends and air bangs, flowing dynamically in the wind", 
                "Silky long straight hair with wispy see-through bangs, fluttering in the breeze", 
                "Low loose ponytail with soft bangs framing the face, elegant and casual", 
                "Long layered hair with curtain bangs, blowing gently",
                "Waist-length gentle waves with see-through bangs, wind-blown effect"
            ];
            
            const rFace = faceShapes[Math.floor(Math.random() * faceShapes.length)];
            const rEyes = eyeTypes[Math.floor(Math.random() * eyeTypes.length)];
            const rHair = hairStyles[Math.floor(Math.random() * hairStyles.length)];

            // UPDATED MODEL DEFINITION (Dynamic Features)
            const modelDesc = `SOLO SHOT. SINGLE SUBJECT ONLY. Elegant Asian female fashion model with a sophisticated aura. Features: ${rHair}, ${rFace}, ${rEyes}, natural skin texture with visible pores, light makeup, hyper-realistic eyes. Body: Tall, elegant model stature, stylish posture.`;
            
            // --- SEASONAL & STYLE LOGIC INJECTION ---
            // New: Randomly toggle between Office (Work), Casual (Weekend), and Date (Romantic) styles
            const styleTypes = ['OFFICE', 'CASUAL', 'DATE'];
            const currentStyle = styleTypes[Math.floor(Math.random() * styleTypes.length)];
            
            let seasonFashion = "";
            let seasonEnv = "";

            switch(state.season) {
                case 'spring':
                    if (currentStyle === 'OFFICE') {
                        seasonFashion = "Outfit: SPRING BUSINESS LOOK (2026). Pastel tailored blazer, silk blouse, high-waisted trousers. Sharp and professional.";
                    } else if (currentStyle === 'DATE') {
                        seasonFashion = "Outfit: SPRING DATE LOOK (2026). Romantic pink floral chiffon dress, soft cardigan falling off shoulder, delicate gold jewelry. Sweet and feminine.";
                    } else {
                        seasonFashion = "Outfit: SPRING CASUAL LOOK (2026). Flowy trench coat over a white tee and jeans, light knit cardigan. Soft and relaxed.";
                    }
                    seasonEnv = "Background: Tokyo Omotesando pavement in SPRING. Cherry blossoms (Sakura) petals on the ground, fresh greenery, soft bokeh.";
                    break;
                    
                case 'summer':
                    if (currentStyle === 'OFFICE') {
                        seasonFashion = "Outfit: SUMMER BUSINESS LOOK (2026). Sleeveless structured vest top, wide-leg linen trousers, elegant watch. Cool and chic.";
                    } else if (currentStyle === 'DATE') {
                        seasonFashion = "Outfit: SUMMER DATE LOOK (2026). White off-shoulder silk top, high-slit satin midi skirt, strappy heeled sandals. Alluring and glowing.";
                    } else {
                        seasonFashion = "Outfit: SUMMER CASUAL LOOK (2026). Simple high-quality white tee with a silk slip skirt, sunglasses. Breezy and minimal.";
                    }
                    seasonEnv = "Background: Tokyo Omotesando asphalt street in SUMMER. Bright vibrant sunlight, sharp tree shadows on the road, energetic vibe, heat shimmer.";
                    break;
                    
                case 'winter':
                    if (currentStyle === 'OFFICE') {
                        seasonFashion = "Outfit: WINTER BUSINESS LOOK (2026). Long wool structured coat, crisp button-down shirt layered under v-neck sweater, tailored wool pants.";
                    } else if (currentStyle === 'DATE') {
                        seasonFashion = "Outfit: WINTER DATE LOOK (2026). Luxurious white faux-fur coat, velvet slip dress underneath, sheer tights, elegant ankle boots. Festive and romantic.";
                    } else {
                        seasonFashion = "Outfit: WINTER CASUAL LOOK (2026). Oversized puffer jacket (fashionable fit), chunky turtleneck knit, midi skirt with boots. Cozy.";
                    }
                    seasonEnv = "Background: Tokyo Omotesando street in WINTER. Cold crisp air, clear winter atmosphere, soft winter diffused light, festive city vibe.";
                    break;
                    
                case 'autumn':
                default:
                    if (currentStyle === 'OFFICE') {
                        seasonFashion = "Outfit: AUTUMN BUSINESS LOOK (2026). Trench coat belted at waist, pencil skirt, leather boots. Classic and powerful.";
                    } else if (currentStyle === 'DATE') {
                        seasonFashion = "Outfit: AUTUMN DATE LOOK (2026). Soft mohair sweater tucked into a plaid mini skirt, knee-high leather boots, beret. Playful and stylish.";
                    } else {
                        seasonFashion = "Outfit: AUTUMN CASUAL LOOK (2026). Oversized leather jacket over a hoodie, textured wool skirt. Trendy and street.";
                    }
                    seasonEnv = "Background: Tokyo Omotesando textured pavement in AUTUMN. Golden ginkgo leaves scattered on the ground, warm golden hour light.";
                    break;
            }

            const fashionDesc = `${seasonFashion} STRICT ACCESSORY RULE: The model is carrying EXACTLY ONE bag total. Whether it is held in hand, worn on shoulder, or tucked under arm, there must be only ONE single bag visible in the entire image. ABSOLUTELY NO multiple bags.`;
            
            // ADDED: Film photography keywords for realism
            const qualityKeywords = "Masterpiece, award winning street photography, Shot on 35mm film, 85mm lens f/1.8, natural film grain, highly detailed fabric texture, photorealistic, cinematic lighting. REALISTIC GROUND SHADOWS, Ambient Occlusion, Foot contact shadows, Cast shadow on pavement. NO OTHER PEOPLE, EMPTY STREET BACKGROUND. Magazine Editorial Quality.";
            
            // UPDATED SAFETY PROMPT
            const safety = "NO text, NO watermark, NO distorted limbs, NO blurry face. Fully clothed, elegant street style, professional fashion photography standards.";

            let prompt = "";
            
            if (type === 'gen') {
                let colorD = "Palette: Neutral chic tones.";
                if (state.mode === 'palette') {
                    const pal = PALETTES[state.pIndex];
                    colorD = `COLOR COORDINATION: Masterpiece layered outfit using palette: ${pal.colors.slice(0,4).join(', ')}. 
                    STYLING STRATEGY (Color Blocking by Layer):
                    1. OUTERWEAR: Solid color HEX ${pal.colors[0]}.
                    2. INNERWEAR: Solid color HEX ${pal.colors[1]} (Creating depth).
                    3. BOTTOMS: Solid color HEX ${pal.colors[0]} or ${pal.colors[2]}.
                    4. ACCENTS (Bag/Shoes): HEX ${pal.colors[3] || pal.colors[1]}.
                    CONSTRAINT: Each garment must be a SINGLE SOLID COLOR. NO split-colored clothes. NO patchwork.`;
                } else if (state.mode === 'single') {
                    const col = COLORS[state.cIndex];
                    const cName = I18N[col.nameKey]['en-US'];
                    colorD = `COLOR THEME: Monochromatic high-fashion look in ${cName} (HEX ${col.hex}). The entire outfit (Inner, Outer, Bottoms) utilizes different textures in shades of ${cName} to create depth without changing color.`;
                }
                
                prompt = `Full body candid shot. ${modelDesc} ${fashionDesc} Action: ${p} + ${randomDetail}. ${colorD} ${seasonEnv} Lighting: ${randomLight}. ${qualityKeywords} ${ratioP}. ${safety}`;
                
            } else {
                // EDIT MODE
                let instruction = "";
                
                if (state.mode === 'palette') {
                    const pal = PALETTES[state.pIndex];
                    instruction = `Recolor the outfit to match this palette: Primary ${pal.colors[0]}, Secondary ${pal.colors[1]}. Keep face and skin natural.`;
                } else {
                    const col = COLORS[state.cIndex];
                    const cName = I18N[col.nameKey]['en-US'];
                    instruction = `Change the entire outfit color to ${cName} (HEX ${col.hex}). Keep face and skin natural. Maintain fabric texture.`;
                }
                
                prompt = `Professional photo editing. ${instruction} Retain the original ${state.season} street background and lighting: ${randomLight}. High quality photorealism. ${safety}`;
            }

            try {
                let url, body;
                if(type === 'gen') {
                    url = `https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`;
                    body = { instances: [{ prompt }], parameters: { sampleCount: 1, aspectRatio: state.ratio } };
                } else {
                    const base64 = state.image.includes(',') ? state.image.split(',')[1] : state.image;
                    url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;
                    
                    body = { 
                        contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/png", data: base64 } }] }], 
                        generationConfig: { responseModalities: ["IMAGE"] },
                        safetySettings: [
                            { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_ONLY_HIGH" },
                            { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_ONLY_HIGH" },
                            { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_ONLY_HIGH" },
                            { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_ONLY_HIGH" }
                        ]
                    };
                }

                const res = await fetchWithRetry(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) });
                const data = await res.json();
                
                console.log("API Response:", data);

                let imgData;
                let isSafetyBlocked = false;

                if (type === 'gen') {
                    if (data.predictions?.[0]) {
                        imgData = data.predictions[0].bytesBase64Encoded;
                    }
                } else {
                    const candidate = data.candidates?.[0];
                    if (candidate) {
                        if (candidate.finishReason === "SAFETY" || candidate.finishReason === "RECITATION") {
                            isSafetyBlocked = true;
                            console.warn("Safety Block:", candidate.safetyRatings);
                        } else {
                             const part = candidate.content?.parts?.find(p => p.inlineData);
                             if (part) imgData = part.inlineData.data;
                        }
                    }
                }
                
                if(imgData) {
                    displayImg(`data:image/png;base64,${imgData}`);
                    showToast(I18N[type === 'gen' ? 'msg_gen_success' : 'msg_edit_success'][state.lang]);
                } else if (isSafetyBlocked) {
                     showToast(I18N['error_policy'][state.lang], 'error');
                } else {
                    throw new Error("API Blocked or Failed (No image data)");
                }

            } catch(e) { 
                console.error("API Error Detail:", e);
                showToast(I18N['error_policy'][state.lang] || "Error", 'error');
            } finally { 
                state.loading = false; 
                DOM.loader.classList.add('hidden'); 
                DOM.btnGen.disabled = false;
                DOM.btnApply.disabled = false;
            }
        }

        // --- INIT ---
        DOM.btnGen.onclick = () => apiCall('gen');
        DOM.btnApply.onclick = () => apiCall('edit');
        DOM.fileInput.onchange = e => { 
            const f = e.target.files[0]; 
            if(f) { 
                const r = new FileReader(); 
                r.onload = ev => displayImg(ev.target.result); 
                r.readAsDataURL(f); 
            } 
        };
        
        lucide.createIcons(); 
        render(); 
    </script>
</body>
</html>
