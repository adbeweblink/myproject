<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
      :root {
        --adobe-red: #DA1F26;
        --brand-blue: #1473E6;
        --doc-purple: #5514E6;
        --bg-light: #F5F5F5;
        --border-color: #E1E1E1;
        --surface: #FFFFFF;
        --text-primary: #2C2C2C;
      }
      body { font-family: 'Roboto', sans-serif; background: var(--bg-light); display: flex; justify-content: center; margin: 0; padding: 20px; color: var(--text-primary); }
      .app-wrapper { width: 100%; max-width: 480px; background: var(--surface); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); overflow: hidden; border: 1px solid var(--border-color); position: relative; }
      
      /* Header */
      .header { padding: 15px 24px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; background: #fff; }
      .header-title { display: flex; align-items: center; gap: 12px; }
      .logo-icon { width: 32px; height: 32px; background: var(--adobe-red); color: white; font-weight: 900; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 18px; }
      .header h1 { font-size: 18px; margin: 0; font-weight: 700; color: #333; }
      .header p { font-size: 12px; color: #666; margin: 2px 0 0 0; }
      
      /* Test Button */
      .test-api-btn { font-size: 11px; color: var(--brand-blue); background: none; border: 1px solid var(--brand-blue); padding: 4px 8px; border-radius: 4px; cursor: pointer; transition: 0.2s; white-space: nowrap;}
      .test-api-btn:hover { background: #E3F2FD; }
      
      /* Content */
      .content { padding: 24px; }
      .form-section { background: #fff; border: 1px solid #eee; border-radius: 6px; padding: 16px; margin-bottom: 20px; }
      .section-label { font-size: 11px; font-weight: 700; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; display: block; border-bottom: 1px solid #eee; padding-bottom: 8px; }
      
      /* Mode Selector */
      .mode-selector { display: flex; gap: 12px; margin-bottom: 15px; }
      .mode-selector input { display: none; }
      .mode-selector label { 
        flex: 1; text-align: center; padding: 20px 10px; border: 2px solid transparent; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; color: #555; background: #F0F0F0; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      }
      #modeCC:checked + label { border-color: var(--adobe-red); background: #FFF5F5; color: var(--adobe-red); box-shadow: 0 4px 8px rgba(218, 31, 38, 0.15); transform: translateY(-2px); }
      #modeDC:checked + label { border-color: var(--doc-purple); background: #F8F5FF; color: var(--doc-purple); box-shadow: 0 4px 8px rgba(85, 20, 230, 0.15); transform: translateY(-2px); }
      .mode-icon { display: block; font-size: 24px; margin-bottom: 8px; }
      
      /* Form Inputs */
      label.field-label { display: block; font-size: 13px; font-weight: 500; margin-bottom: 6px; color: #444; }
      select, input[type=number] { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; box-sizing: border-box; background: #fff; transition: border 0.2s; }
      select:focus, input:focus { outline: none; border-color: var(--brand-blue); }
      
      /* Submit Button */
      .submit-btn { width: 100%; padding: 15px; background: var(--brand-blue); color: white; border: none; border-radius: 25px; font-size: 16px; font-weight: 700; cursor: pointer; margin-top: 10px; transition: all 0.2s; display: flex; justify-content: center; align-items: center; gap: 8px; }
      .submit-btn:hover { background: #0D66D0; transform: scale(1.02); }
      .submit-btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }
      
      /* Tags */
      .tag-container { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 10px; }
      .tag { font-size: 11px; padding: 4px 8px; background: #eee; border-radius: 4px; color: #555; border: 1px solid transparent; }
      
      /* Status */
      #status { margin-top: 20px; padding: 16px; border-radius: 6px; font-size: 13px; text-align: center; display: none; line-height: 1.6; }
      .success { background: #E9F7EF; color: #1E8449; border: 1px solid #C3E6CB; }
      .error { background: #FDEDEC; color: #C0392B; border: 1px solid #F5C6CB; }
      .loading { background: #EBF5FB; color: #007AA8; border: 1px solid #D6EAF8; }
      .api-ok { color: #2E7D32; font-weight: bold; margin-top:5px; font-size:11px; }
      .api-err { color: #C62828; font-weight: bold; margin-top:5px; font-size:11px; }
      
      .jump-btn { display: inline-block; margin-top: 10px; padding: 8px 16px; background: var(--brand-blue); color: white; text-decoration: none; border-radius: 4px; font-size: 13px; font-weight: 500; }
      .jump-btn:hover { background: #0D66D0; }

      .footer { text-align: center; font-size: 11px; color: #999; margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee; }
      
      /* Modal Styles (Confirmation) */
      .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 100; }
      .modal-box { background: white; width: 85%; max-width: 320px; padding: 24px; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align: center; }
      .modal-title { font-size: 18px; font-weight: bold; margin-bottom: 15px; color: #333; }
      .modal-content { text-align: left; font-size: 13px; color: #555; background: #f9f9f9; padding: 15px; border-radius: 6px; margin-bottom: 20px; }
      .modal-item { margin-bottom: 8px; display: flex; justify-content: space-between; border-bottom: 1px dashed #eee; padding-bottom: 4px; }
      .modal-item strong { color: #333; }
      .modal-btns { display: flex; gap: 10px; }
      .modal-btn { flex: 1; padding: 10px; border-radius: 4px; cursor: pointer; border: none; font-weight: bold; }
      .btn-cancel { background: #eee; color: #666; }
      .btn-confirm { background: var(--brand-blue); color: white; }

      /* Animation */
      @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }
      .loading-dots { animation: pulse 1.5s infinite; }
      
      /* Progress Bar */
      .progress-box { margin-top: 12px; text-align: left; }
      .progress-bg { background: rgba(0,0,0,0.1); border-radius: 4px; height: 6px; width: 100%; overflow: hidden; margin-bottom: 6px; }
      .progress-fill { background: var(--brand-blue); height: 100%; width: 0%; transition: width 0.3s ease; border-radius: 4px; }
      .progress-info { display: flex; justify-content: space-between; font-size: 11px; color: #555; font-weight: 500; }
      .loading-text { font-weight: bold; margin-bottom: 4px; display: block; }
    </style>
  </head>
  <body>
    <div class="app-wrapper">
      <!-- Header -->
      <div class="header">
        <div class="header-title">
          <div class="logo-icon">Ad</div>
          <div>
            <h1>Adobe æ½›åœ¨å®¢æˆ¶é–‹ç™¼</h1>
            <p>æ–°å‰µåå–®æœå°‹å¼•æ“</p>
          </div>
        </div>
        <button type="button" class="test-api-btn" onclick="testConnection()">âš¡ æ¸¬è©¦é€£ç·š</button>
      </div>
      <div id="testStatus" style="text-align:center; display:none;"></div>

      <div class="content">
        <form id="crawlerForm">
          
          <!-- 1. æ¨¡å¼é¸æ“‡ -->
          <div class="form-section">
            <span class="section-label">01. é¸æ“‡ç”¢å“æˆ°ç•¥</span>
            <div class="mode-selector">
              <input type="radio" name="pMode" id="modeCC" value="CC" checked onchange="setMode('CC')">
              <label for="modeCC">
                <span class="mode-icon">ğŸ¨</span>
                Creative Cloud<br><span style="font-size:11px; font-weight:normal;">è¨­è¨ˆ / å½±è¦– / è¡ŒéŠ·</span>
              </label>
              
              <input type="radio" name="pMode" id="modeDC" value="DC" onchange="setMode('DC')">
              <label for="modeDC">
                <span class="mode-icon">ğŸ“„</span>
                Document Cloud<br><span style="font-size:11px; font-weight:normal;">æ–‡ä»¶ / åˆç´„ / æµç¨‹</span>
              </label>
            </div>
            
            <div id="ccBlock">
              <label class="field-label">CC ç›®æ¨™ç”¢æ¥­</label>
              <select id="ccSelect" onchange="updateKeys('CC')">
                <option value="marketing" data-tag="CC-MKT">æ•¸ä½è¡ŒéŠ· / å»£å‘Š / å…¬é—œå…¬å¸</option>
                <option value="video" data-tag="CC-VID">å½±è¦–è£½ä½œ / å¾ŒæœŸç‰¹æ•ˆ / è‡ªåª’é«”</option>
                <option value="game" data-tag="CC-GAME">éŠæˆ²é–‹ç™¼ / VR / å¤šåª’é«”äº’å‹•</option>
                <option value="design" data-tag="CC-PRINT">å¹³é¢è¨­è¨ˆ / å°åˆ· / å‡ºç‰ˆç¤¾</option>
                <option value="ecommerce" data-tag="CC-ECOM">é›»å•† / ç¶²æ‹ / å“ç‰Œé›¶å”®</option>
              </select>
            </div>

            <div id="dcBlock" style="display:none;">
               <label class="field-label">DC ç›®æ¨™ç”¢æ¥­</label>
               <select id="dcSelect" onchange="updateKeys('DC')">
                 <option value="acrobat_legal" data-tag="DC-LEGAL">æ³•å¾‹äº‹å‹™æ‰€ / æœƒè¨ˆ / é¡§å•</option>
                 <option value="acrobat_eng" data-tag="DC-ENG">å·¥ç¨‹ç‡Ÿé€  / å»ºç¯‰å¸« / æ©Ÿé›»</option>
                 <option value="acrobat_mfg" data-tag="DC-MFG">ç²¾å¯†è£½é€  / ç”ŸæŠ€ / é†«ç™‚å™¨æ</option>
                 <option value="acrobat_trade" data-tag="DC-TRADE">é€²å‡ºå£è²¿æ˜“ / ç‰©æµ / å ±é—œè¡Œ</option>
               </select>
            </div>
            
            <div class="tag-container" id="previewTags"></div>
          </div>

          <!-- 2. ç¯©é¸æ¢ä»¶ -->
          <div class="form-section">
            <span class="section-label">02. è¦æ¨¡èˆ‡åœ°å€</span>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
              <div>
                <label class="field-label">æœ€ä½è³‡æœ¬é¡</label>
                <select id="minCapital">
                  <option value="1000000">100 è¬+</option>
                  <option value="3000000">300 è¬+</option>
                  <option value="5000000" selected>500 è¬+</option>
                  <option value="10000000">1,000 è¬+</option>
                </select>
              </div>
              
              <div>
                <label class="field-label">è² è²¬å€åŸŸ</label>
                <select id="region">
                  <option value="all">å…¨å°ç£</option>
                  <option value="north">åŒ—éƒ¨</option>
                  <option value="central">ä¸­éƒ¨</option>
                  <option value="south">å—éƒ¨</option>
                  <option value="east">æ±éƒ¨</option>
                </select>
              </div>
            </div>
            
            <label class="field-label" style="margin-top:12px;">æ–°å‰µå®šç¾©</label>
            <select id="targetYears">
              <option value="0.083">ğŸ”´ è¿‘ 1 å€‹æœˆ (æœ€æ–°è¨­ç«‹)</option>
              <option value="0.5" selected>ğŸŸ¡ è¿‘åŠå¹´å…§ (å»ºè­°)</option>
              <option value="1">ğŸŸ¢ è¿‘ 1 å¹´å…§</option>
              <option value="3">ğŸ”µ è¿‘ 3 å¹´å…§</option>
            </select>
            
            <div style="margin-top:12px; display:flex; align-items:center; background:#f9f9f9; padding:8px; border-radius:4px;">
              <input type="checkbox" id="excludeSmall" checked>
              <label for="excludeSmall" style="margin-left:8px; font-size:13px; cursor:pointer;">è‡ªå‹•æ’é™¤ ä¼æ¥­ç¤¾/å€‹äººå·¥ä½œå®¤</label>
            </div>
          </div>

          <button type="button" class="submit-btn" id="preCheckBtn" onclick="showConfirmModal()">
            <span>ğŸš€ å•Ÿå‹•æœå°‹å¼•æ“</span>
          </button>
        </form>
        <div id="status"></div>
      </div>
      
      <div class="footer">Data Source: data.gov.tw | Apps Script Powered</div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal-overlay" id="confirmModal">
      <div class="modal-box">
        <div class="modal-title">ğŸ” ç¢ºèªæœå°‹æ¢ä»¶</div>
        <div class="modal-content">
          <div class="modal-item"><span>ç”¢å“æ¨¡å¼ï¼š</span><strong id="mMode"></strong></div>
          <div class="modal-item"><span>ç›®æ¨™ç”¢æ¥­ï¼š</span><strong id="mTag"></strong></div>
          <div class="modal-item"><span>æœ€ä½è³‡æœ¬ï¼š</span><strong id="mCap"></strong></div>
          <div class="modal-item"><span>è² è²¬å€åŸŸï¼š</span><strong id="mReg"></strong></div>
          <div class="modal-item"><span>æ–°å‰µé€±æœŸï¼š</span><strong id="mYear"></strong></div>
        </div>
        <div style="font-size:12px; color:#888; margin-bottom:15px;">ç¢ºèªç„¡èª¤å¾Œå°‡é–‹å§‹é€£ç·šï¼Œéç¨‹ç´„éœ€ 10-30 ç§’ã€‚</div>
        <div class="modal-btns">
          <button class="modal-btn btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
          <button class="modal-btn btn-confirm" onclick="startSearch()">ç¢ºèªåŸ·è¡Œ</button>
        </div>
      </div>
    </div>

    <script>
      const strategies = {
        marketing: ["è¡ŒéŠ·", "å»£å‘Š", "æ•¸ä½", "å‚³æ’­", "å…¬é—œ", "ç­–åŠƒ", "å¤šåª’é«”"],
        video: ["å½±è¦–", "å‚³åª’", "è£½ä½œ", "æ˜ åƒ", "å‹•ç•«", "å¾ŒæœŸ", "è¦–è¦º"],
        game: ["éŠæˆ²", "é›»ç«¶", "å‹•ç•«", "è™›æ“¬", "è»Ÿé«”é–‹ç™¼"],
        design: ["è¨­è¨ˆ", "å°åˆ·", "åœ–æ›¸", "å‡ºç‰ˆ", "æ–‡å‰µ", "ç¾å­¸"],
        ecommerce: ["é›»å­å•†å‹™", "åœ‹éš›è²¿æ˜“", "é›¶å”®", "ç™¾è²¨", "å“ç‰Œ", "ç¶²è³¼"],
        acrobat_legal: ["æ³•å¾‹", "æœƒè¨ˆ", "é¡§å•", "å°ˆåˆ©", "äº‹å‹™æ‰€", "äººè³‡"],
        acrobat_eng: ["ç‡Ÿé€ ", "å»ºè¨­", "å·¥ç¨‹", "å»ºç¯‰", "æ©Ÿé›»", "èƒ½æº"],
        acrobat_mfg: ["ç”Ÿç‰©ç§‘æŠ€", "é†«ç™‚", "ç²¾å¯†", "ç§‘æŠ€", "ææ–™", "è£½é€ "],
        acrobat_trade: ["å ±é—œ", "ç‰©æµ", "èˆªé‹", "å€‰å„²", "é€²å‡ºå£", "æ‰¿æ”¬"]
      };

      let currentKeywords = [];
      let currentTag = "";
      let currentMode = "CC";
      let progressTimer = null;

      function init() {
        const savedRegion = localStorage.getItem('adobe_region');
        if (savedRegion) document.getElementById('region').value = savedRegion;
        setMode('CC');
      }

      function setMode(mode) {
        currentMode = mode;
        document.getElementById('ccBlock').style.display = mode === 'CC' ? 'block' : 'none';
        document.getElementById('dcBlock').style.display = mode === 'DC' ? 'block' : 'none';
        updateKeys(mode);
      }

      function updateKeys(mode) {
        const selectId = mode === 'CC' ? 'ccSelect' : 'dcSelect';
        const el = document.getElementById(selectId);
        const val = el.value;
        currentTag = el.options[el.selectedIndex].getAttribute('data-tag');
        currentKeywords = strategies[val] || [];
        
        const tagBox = document.getElementById('previewTags');
        const color = mode === 'CC' ? '#DA1F26' : '#5514E6';
        tagBox.innerHTML = currentKeywords.map(k => 
          `<span class="tag" style="color:${color}; border:1px solid ${color}33;">#${k}</span>`
        ).join('');
      }

      // æ¸¬è©¦é€£ç·šåŠŸèƒ½
      function testConnection() {
        const statusDiv = document.getElementById('testStatus');
        const btn = document.querySelector('.test-api-btn');
        btn.textContent = "é€£ç·šä¸­...";
        btn.disabled = true;
        statusDiv.style.display = 'block';
        statusDiv.innerHTML = '<span style="color:#666;">æ­£åœ¨æ¸¬è©¦æ”¿åºœ API å›æ‡‰é€Ÿåº¦...</span>';

        google.script.run.withSuccessHandler(res => {
          btn.textContent = "âš¡ æ¸¬è©¦é€£ç·š";
          btn.disabled = false;
          if (res.success) {
            statusDiv.innerHTML = `<div class="api-ok">âœ… API é€£ç·šæ­£å¸¸ï¼å»¶é²: ${res.latency}ms</div>`;
            setTimeout(() => { statusDiv.style.display = 'none'; }, 5000);
          } else {
            statusDiv.innerHTML = `<div class="api-err">âŒ API é€£ç·šç•°å¸¸: ${res.msg}</div>`;
          }
        }).testApiConnection();
      }

      // é¡¯ç¤ºç¢ºèªè¦–çª—
      function showConfirmModal() {
        // æ”¶é›†è³‡æ–™
        const selId = currentMode === 'CC' ? 'ccSelect' : 'dcSelect';
        const industryText = document.getElementById(selId).options[document.getElementById(selId).selectedIndex].text;
        const cap = document.getElementById('minCapital');
        const reg = document.getElementById('region');
        const year = document.getElementById('targetYears');

        // å¡«å…¥è¦–çª—
        document.getElementById('mMode').textContent = currentMode === 'CC' ? 'Creative Cloud' : 'Document Cloud';
        document.getElementById('mTag').textContent = industryText.split('/')[0]; // å–ç¬¬ä¸€å€‹é—œéµå­—ç•¶ä»£è¡¨
        document.getElementById('mCap').textContent = cap.options[cap.selectedIndex].text;
        document.getElementById('mReg').textContent = reg.options[reg.selectedIndex].text;
        document.getElementById('mYear').textContent = year.options[year.selectedIndex].text;

        // é¡¯ç¤º
        document.getElementById('confirmModal').style.display = 'flex';
      }

      function closeModal() {
        document.getElementById('confirmModal').style.display = 'none';
      }

      // æ­£å¼é–‹å§‹æœå°‹
      function startSearch() {
        closeModal();
        
        localStorage.setItem('adobe_region', document.getElementById('region').value);

        const btn = document.getElementById('preCheckBtn');
        const status = document.getElementById('status');
        
        btn.disabled = true;
        btn.innerHTML = '<span class="loading-dots">è™•ç†ä¸­</span>';
        
        // å•Ÿå‹•é€²åº¦æ¢
        startProgress();

        const payload = {
          productMode: currentMode,
          salesTag: currentTag,
          keywords: currentKeywords.join(','),
          minCapital: document.getElementById('minCapital').value,
          region: document.getElementById('region').value,
          targetYears: document.getElementById('targetYears').value,
          excludeSmall: document.getElementById('excludeSmall').checked ? "true" : "false"
        };

        google.script.run
          .withSuccessHandler(res => {
            clearInterval(progressTimer);
            btn.disabled = false;
            btn.innerHTML = "ğŸš€ å•Ÿå‹•æœå°‹å¼•æ“";
            
            // å¼·åˆ¶è¨­å®š 100%
            const pBar = document.getElementById('pBar');
            if(pBar) pBar.style.width = '100%';
            
            if (res.success) {
              status.className = 'success';
              const link = `https://docs.google.com/spreadsheets/d/${res.sheetId}`;
              status.innerHTML = `<strong>${res.message}</strong><br><a href="${link}" target="_blank" class="jump-btn">é–‹å•Ÿ Google è©¦ç®—è¡¨åå–®</a>`;
            } else {
              status.className = 'error';
              status.textContent = res.message;
            }
          })
          .withFailureHandler(err => {
            clearInterval(progressTimer);
            btn.disabled = false;
            btn.innerHTML = "ğŸš€ å•Ÿå‹•æœå°‹å¼•æ“";
            status.className = 'error';
            status.textContent = "ç³»çµ±é€£ç·šéŒ¯èª¤: " + err.message;
          })
          .processForm(payload);
      }

      // é€²åº¦æ¢é‚è¼¯
      function startProgress() {
        const status = document.getElementById('status');
        let percent = 0;
        let timeLeft = 20;
        
        const messages = [
          "æ­£åœ¨é€£ç·šæ”¿åºœ API...", "ä¸‹è¼‰æœ€æ–°è³‡æ–™...", "é€²è¡Œç”¢æ¥­æ¯”å°...", "éæ¿¾è³‡æœ¬é¡...", "é‡è¤‡æª¢æŸ¥ä¸­..."
        ];

        status.style.display = 'block';
        status.className = 'loading';
        status.innerHTML = `
          <span class="loading-text" id="msgText">${messages[0]}</span>
          <div class="progress-box">
            <div class="progress-bg"><div class="progress-fill" id="pBar"></div></div>
            <div class="progress-info">
              <span id="pPercent">0%</span>
              <span id="pTime">é è¨ˆ ${timeLeft} ç§’</span>
            </div>
          </div>
        `;

        progressTimer = setInterval(() => {
          const increment = Math.random() * 5; 
          percent += increment;
          if (percent % 10 < 2) timeLeft = Math.max(1, timeLeft - 1);
          if (percent > 95) { percent = 95; timeLeft = 1; }

          document.getElementById('pBar').style.width = percent + '%';
          document.getElementById('pPercent').textContent = Math.floor(percent) + '%';
          document.getElementById('pTime').textContent = `é è¨ˆ ${timeLeft} ç§’`;
          
          const msgIndex = Math.min(messages.length - 1, Math.floor(percent / 20));
          const msgEl = document.getElementById('msgText');
          if (msgEl) msgEl.textContent = messages[msgIndex];
        }, 500);
      }

      init();
    </script>
  </body>
</html>
